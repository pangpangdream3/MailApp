# Keymaker

Encryption of locally stored data: Keychain items, CoreData attributes, UserDefaults entries. Wrapper for Keychain access. Autolocker to lock the app after certain time in background.

High-level overview is available in Threat Model writeups:
- General audience: https://protonmail.com/blog/ios-security-model/
- Public, more technical: https://github.com/ProtonMail/ios-mail/tree/master/ProtonMail
- Private, full technical, dirty: https://github.com/ProtonMail/protonmail_ios/wiki/Threat-Model

**TL;DR:** 
1. We generate MainKey (marketing name AppKey), encrypt it with intermediate key produced by one of protection strategies (None, PIN, Biometric) and store this cyphertext on the Keychain. Then all critical data that needs to be stored locally is encrypted with cleartext MainKey. MainKey can only be stored in process memory, user have to unlock it on each launch and each time the app is Locked. No MainKey - no data;
2. In case of Biometric protection MainKey is encrypted with public key generated by SecureEnclave and only SecureEnclave has private key to decrypt it. Since SecureEnclave is not compromised up to date, this way can be considered more or less secure even when kernel is compromised;
3. In case of PIN protection intermediate key is derived from user input at each attempt to decrypt MainKey. Provided user has a long good PIN (because cache can be stolen and PIN can be brooteforced off-device), this can be considered more or less secure;
4. In case of None protection the internediate key itself is stored in Keychain, which in case of data extraction attack (Cellebrite, GrayKey, ElcomSoft) or sandbox-escaping malware (PoisonCarp, jailbreak-based spyware) makes getting local data just a matter of thorough reading our open source code.

**Important**: key management is crytical. Nothing is secured if you use MainKey improperly or forget to remove it from process memory.

## Dependencies
- [PMCrypto](https://gitlab.protontech.ch/apple/shared/pmcrypto)
- [EllipticCurveKeyPair](https://github.com/agens-no/EllipticCurveKeyPair), Swift 4.2 at the moment

## Linter
We use SwiftLint to enforce consistent styling across codebase. 
Linter is installed as cocoapod. 
Configuration is in a  hidden file `.swiftlint.yml`.

## Unit tests
This project has number of unit tests, automatically run via Fastlane by GitLab CI.
Configuration of CI: hidden file `.gitlab-ci.yml`.
Configuration of fastlane: `/fastlane/Fastfile`.